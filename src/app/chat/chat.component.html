<div class="relative">
  <!-- Custom Sidebar -->
  <div
    class="fixed top-0 left-0 h-screen w-80 bg-base-200 shadow-xl transition-transform duration-300 z-50"
    [class.-translate-x-full]="!sidebarOpen"
  >
    <div class="flex flex-col h-full p-4">
      <!-- Sidebar header -->
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">Agent X</h2>
        <button
          (click)="sidebarOpen = false"
          class="btn btn-sm btn-circle btn-ghost"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      <!-- Divider -->
      <div class="divider mt-0"></div>

      <!-- Chat history section (placeholder for future) -->
      <div class="flex-1 overflow-y-auto">
        <h3 class="text-sm font-semibold opacity-60 mb-3">Chat History</h3>
        <p class="text-sm opacity-50 italic">No previous conversations</p>

        <!-- Future chat history items will go here -->
      </div>

      <!-- Sidebar footer -->
      <div class="mt-auto pt-4">
        <div class="divider mt-0"></div>
        <button class="btn btn-outline btn-sm w-full">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 mr-2"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"
            />
          </svg>
          New Chat
        </button>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <div class="flex flex-col h-screen w-full relative">
    <!-- Header with menu button -->
    <div class="absolute top-4 left-4 z-20">
      <button
        (click)="sidebarOpen = !sidebarOpen"
        class="btn btn-circle btn-ghost"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          class="inline-block w-6 h-6 stroke-current"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Welcome message centered in the entire viewport -->
    <div
      *ngIf="messages.length === 1 && messages[0].role === 'ai'"
      class="flex flex-col items-center justify-center text-center absolute inset-0 pointer-events-none z-10 pb-32"
    >
      <h2 class="text-3xl font-bold mb-2">Hello there!</h2>
      <p class="text-lg opacity-70">How can I help you today?</p>
    </div>

    <div
      #scroll
      class="flex-1 overflow-y-auto pb-8 relative"
      style="overflow-anchor: none"
    >
      <div
        class="flex flex-col p-2 space-y-3"
        [class.min-h-full]="
          messages.length > 1 ||
          (messages.length === 1 && messages[0].role !== 'ai')
        "
      >
        <!-- Welcome message placeholder (hidden) -->
        <div
          *ngIf="messages.length === 1 && messages[0].role === 'ai'"
          class="invisible"
        ></div>

        <!-- Regular chat messages -->
        <ng-container
          *ngIf="
            messages.length > 1 ||
            (messages.length === 1 && messages[0].role !== 'ai')
          "
        >
          <div *ngFor="let m of messages" class="mb-6">
            <!-- AI message without bubble -->
            <div *ngIf="m.role === 'ai'" class="flex items-start gap-3">
              <div class="avatar placeholder">
                <div
                  class="bg-neutral text-neutral-content rounded-full w-8 h-8 flex items-center justify-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="w-5 h-5"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"
                    />
                  </svg>
                </div>
              </div>
              <div class="flex-1 max-w-3xl">
                <div
                  class="whitespace-pre-wrap break-words text-base leading-7"
                >
                  {{ m.text }}
                </div>
                <div class="text-xs opacity-50 mt-2">
                  {{ m.timestamp | date : "shortTime" }}
                </div>
              </div>
            </div>

            <!-- User message with bubble -->
            <div *ngIf="m.role === 'user'" class="flex justify-end">
              <div
                class="bg-blue-600 text-white rounded-3xl px-5 py-3 max-w-[70%] break-words overflow-wrap-anywhere"
              >
                <div class="whitespace-pre-wrap break-words">{{ m.text }}</div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Bottom marker element for scroll tracking -->
        <div class="min-h-[24px] min-w-[24px] shrink-0"></div>
      </div>

      <!-- Scroll to bottom button (shown when user scrolls up) -->
      <button
        *ngIf="(isAtBottom$ | async) === false"
        class="absolute bottom-8 left-1/2 -translate-x-1/2 z-20 btn btn-circle btn-sm bg-base-100 shadow-lg hover:bg-base-200 border border-base-300"
        (click)="scrollToBottom()"
        type="button"
        aria-label="Scroll to bottom"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          class="w-4 h-4"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M19 14l-7 7m0 0l-7-7m7 7V3"
          />
        </svg>
      </button>
    </div>

    <div class="p-4 border-white/10">
      <div
        class="relative flex items-end bg-base-300 rounded-lg max-w-4xl mx-auto"
      >
        <textarea
          #messageInput
          [(ngModel)]="inputText"
          (keydown.enter)="onEnterPress($event)"
          (input)="autoResize($event)"
          placeholder="Send a message..."
          rows="3"
          class="textarea flex-1 bg-transparent border-none focus:outline-none resize-none overflow-y-auto min-h-[80px] max-h-[200px] py-3 pr-24"
        ></textarea>
        <button
          class="absolute right-2 bottom-2 btn btn-circle bg-transparent hover:bg-base-100 border-none"
          (click)="send()"
          [disabled]="loading"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="w-5 h-5 text-gray-400"
          >
            <path
              d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"
            />
          </svg>
        </button>
      </div>
      <div
        *ngIf="loading"
        class="mt-2 text-sm opacity-70 flex items-center gap-2 max-w-4xl mx-auto"
      >
        <span class="loading loading-dots"></span> Sending...
      </div>
    </div>
  </div>
</div>
